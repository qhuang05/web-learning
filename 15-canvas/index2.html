<!DOCTYPE html>
<html>

<head>
  <script src="./js/konva.js"></script>
  <script src="./js/touch-emulator.js"></script>
  <script src="./js/hammer-konva.js"></script>
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta charset="utf-8" />
  <title>konva移动端事件</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f0f0f0;
    }
  </style>
</head>

<body>
  <div id="container"></div>
  <script>
    function writeMessage(message) {
      const txt = text.text();
      text.text(message);
      layer.draw();
    }

    var stage = new Konva.Stage({
      container: 'container',
      width: window.innerWidth,
      height: window.innerHeight
    });

    var layer = new Konva.Layer();

    var triangle = new Konva.RegularPolygon({
      x: 80,
      y: 120,
      sides: 3,
      radius: 80,
      fill: '#00D2FF',
      stroke: 'black',
      strokeWidth: 4,
      draggable: true
    });

    var text = new Konva.Text({
      x: 10,
      y: 10,
      fontFamily: 'Calibri',
      fontSize: 24,
      text: '',
      fill: 'black'
    });

    var circle = new Konva.Circle({
      x: 230,
      y: 100,
      radius: 60,
      fill: 'red',
      stroke: 'black',
      strokeWidth: 4,
      draggable: true
    });
    layer.add(triangle);
    layer.add(circle);
    layer.add(text);
    stage.add(layer);

    let curNode = null;
    const selectNode = (node) => {
      if (pinchFlag) return;
      curNode = node;
      layer.find('Transformer')?.destroy();
      const tr = new Konva.Transformer();
      tr.attachTo(node)
      layer.add(tr)
      // circle.setAttrs({ 'draggable': false })
      // triangle.setAttrs({ 'draggable': false })
      // curNode.setAttrs({ 'draggable': true })
      layer.batchDraw()

      tr.on('dragstart', function (e) {
        console.log('dragstart')
      })
      tr.on('dragmove', function (e) {
        console.log('dragmove')
      })
      tr.on('dragend', function (e) {
        console.log('dragend')
      })
    }

    triangle.on('touchstart', function () {
      writeMessage('touchstart')
      selectNode(triangle)
      // setTimeout(() => {
      // }, 200)
    })
    circle.on('touchstart', function () {
      writeMessage('touchstart')
      selectNode(circle)
      // setTimeout(() => {
      // }, 200)
    })

    TouchEmulator();
    Konva.hitOnDragEnabled = true;
    Konva.captureTouchEventsEnabled = true;

    var mc = new Hammer(stage, { domEvents: true });
    mc.get('pinch').set({ enable: true });
    // mc.get('rotate').set({ enable: true });

    let startScaleX, startScaleY, pinchFlag = false;
    mc.on("pinchstart", function (ev) {
      writeMessage('pinchstart')
      if (!curNode) return;
      pinchFlag = true;
      // console.log(ev.type, ev)
      circle.setAttrs({ 'draggable': false })
      triangle.setAttrs({ 'draggable': false })
      startScaleX = curNode.scaleX() || 1;
      startScaleY = curNode.scaleY() || 1;
      layer.batchDraw();
    });
    mc.on("pinch", function (ev) {
      if (!curNode) return;
      curNode.scaleX(startScaleX * ev.scale)
      curNode.scaleY(startScaleY * ev.scale)
      layer.batchDraw();
    });
    mc.on("pinchend", function (ev) {
      pinchFlag = false;
      circle.setAttrs({ 'draggable': true })
      triangle.setAttrs({ 'draggable': true })
    });
    
    let startX, startY, panFlag = false;
    mc.on('panstart', function(ev){
      // console.log('panstart', ev)
      if(!curNode) return;
      startX = curNode.x();
      startY = curNode.y();
    })
    mc.on('panmove', function(ev){
      // console.log('panmove', ev)
      if(!curNode) return;
      curNode.x(startX + ev.deltaX);
      curNode.y(startY + ev.deltaY);
    })
    mc.on('panend', function(ev){
      console.log('panend', ev)
      if(!curNode) return;
    })
  </script>
</body>

</html>